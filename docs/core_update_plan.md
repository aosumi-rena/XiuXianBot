# Core Update Plan

**This plan is generated by AI**

This plan details how to migrate the current project from MongoDB to SQLite and how to rewrite the core server in C#. The Python adapters remain unchanged and communicate with the new server via HTTP.

## Objective 1: Migrate the Database to SQLite
- **Replace connection logic**
  - Remove `MongoClient` usage from `core/database/connection.py` and `core/utils/database.py`.
  - Provide an `sqlite3` connection factory that ensures tables are created on startup.
- **Define database schema**
  - Create a `users` table storing IDs, names, language, and currencies.
  - Create an `items` table tracking item ownership per user.
  - Create a `timings` table for cultivation and other timed actions.
  - Add indices for any frequently queried columns.
- **Rewrite CRUD helpers**
  - Replace all calls to `find_one`, `insert_one`, `update_one`, and `delete_one` with SQL statements.
  - Implement helper functions such as `get_user_by_platform()` and `insert_timing()`.
- **Update configuration**
  - Replace the Mongo URI in `config.json` with `db.sqlite_path`.
  - Default path example:
    ```json
    "db": {
      "sqlite_path": "data/xiu_xian.db",
      "universal_uid_start": 1000000
    }
    ```
- **Create a migration script**
  - Add `scripts/mongo_to_sqlite.py` to copy existing Mongo data into SQLite.
  - Document how to run this script once during the upgrade.
- **Modify dependent modules**
  - Update admin utilities and `web_local/app.py` to use the new helpers.
  - Run Python tests to confirm behaviour is unchanged.
- **Extract language preferences**
  - Store each user's language in `data/language_prefs.json` keyed by their platform UID.
  - Add helper functions in `core/utils/lang_file.py` to load and update this file.
  - Follow the pattern used in [Bestdori-Discord-Bot](https://github.com/aosumi-rena/Bestdori-Discord-Bot) for reference.

## Objective 2: Rewrite the Core Server in C#
- **Set up ASP.NET Core project**
  - Create a `Server/` folder containing the C# source.
  - Add `Program.cs` to host the server and configure routing.
  - Implement `Database.cs` as a wrapper over `System.Data.SQLite`.
- **Recreate REST endpoints**
  - `/health` — return simple status.
  - `/api/user/lookup` — fetch user by platform ID.
  - `/api/register` — create a new account.
  - `/api/stat/{user_id}` — retrieve player status.
  - `/api/cultivate/start` and `/api/cultivate/stop` — manage cultivation sessions.
  - Mirror any additional routes from the Python version.
- **Integrate game logic**
  - Port modules from `core/game/` to C#, or invoke Python logic via REST if needed.
  - Ensure both the C# server and adapters share the same SQLite helpers.
- **Prepare deployment**
  - Build the C# project as a self‑contained binary for the Docker image.
  - Update Docker and documentation to run the new service alongside adapters.

## Objective 3: Architecture Overview
```
[Discord/Telegram/...]
       |
   (Python Adapters)
       |
 HTTP requests
       |
+-----------------------+
|   C# Core Server      |
|  (ASP.NET Core)       |
+-----------------------+
       |
   SQLite Database
```
Adapters send HTTP requests to the C# server. The server executes game logic, reads and writes to SQLite, and returns JSON responses.

## Objective 4: Transitional Steps
- Implement the SQLite layer in Python and verify tests pass.
- Develop the C# server in parallel while keeping the Python server operational.
- Migrate traffic to the C# server once all endpoints are implemented.
- Remove the old Python server and update documentation when the new system is stable.

---
This expanded plan breaks the migration into smaller objectives and tasks for easier tracking.
