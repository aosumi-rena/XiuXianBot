# Core Update Plan

**Plan generated by AI**

This plan details how to migrate the current project from MongoDB to SQLite and how to rewrite the core server in **Java 21**. The Python adapters remain unchanged and communicate with the new server via HTTP.

## Objective 1: Migrate the Database to SQLite
- **Replace connection logic**
  - Remove `MongoClient` usage from `core/database/connection.py` and `core/utils/database.py`.
  - Provide an `sqlite3` connection factory that ensures tables are created on startup.
- **Define database schema**
  - Create a `users` table storing IDs, names, language, and currencies.
  - Create an `items` table tracking item ownership per user.
  - Create a `timings` table for cultivation and other timed actions.
  - Add indices for any frequently queried columns.
- **Rewrite CRUD helpers**
  - Replace all calls to `find_one`, `insert_one`, `update_one`, and `delete_one` with SQL statements.
  - Implement helper functions such as `get_user_by_platform()` and `insert_timing()`.
- **Update configuration**
  - Replace the Mongo URI in `config.json` with `db.sqlite_path`.
  - Default path example:
    ```json
    "db": {
      "sqlite_path": "data/xiu_xian.db",
      "universal_uid_start": 1000000
    }
    ```
- **Create a migration script**
  - Add `scripts/mongo_to_sqlite.py` to copy existing Mongo data into SQLite.
  - Document how to run this script once during the upgrade.
- **Modify dependent modules**
  - Update admin utilities and `web_local/app.py` to use the new helpers.
  - Run Python tests to confirm behaviour is unchanged.
- **Extract language preferences**
  - Store each user's language in `data/language_prefs.json` under platform-specific objects (`discord`, `telegram`).
  - Adapters read this file to decide which localisation to use and provide a `/lang` command to update it.
  - Follow the pattern used in [Bestdori-Discord-Bot](https://github.com/aosumi-rena/Bestdori-Discord-Bot) for reference.

-## Objective 2: Rewrite the Core Server in Java 21
- **Set up Java project**
  - Create a `Server/` folder containing the Java source.
  - Use JDK 21 and a minimal framework (e.g. Spring Boot or Ktor) for the HTTP server.
  - Provide a small database layer using the standard JDBC SQLite driver.
- **Recreate REST endpoints**
  - `/health` — return simple status.
  - `/api/user/lookup` — fetch user by platform ID.
  - `/api/register` — create a new account.
  - `/api/stat/{user_id}` — retrieve player status.
  - `/api/cultivate/start` and `/api/cultivate/stop` — manage cultivation sessions.
  - Mirror any additional routes from the Python version.
- **Integrate game logic**
  - Port modules from `core/game/` to Java, or invoke Python logic via REST if needed.
  - Ensure both the Java server and adapters share the same SQLite helpers.
- **Prepare deployment**
  - Package the Java project into a runnable JAR for the Docker image.
  - Update Docker and documentation to run the new service alongside adapters.

## Objective 3: Architecture Overview
```
[Discord/Telegram/...]
       |
   (Python Adapters)
       |
 HTTP requests
       |
+-----------------------+
|   Java Core Server    |
|   (JDK 21)            |
+-----------------------+
       |
   SQLite Database
```
Adapters send HTTP requests to the Java server. The server executes game logic, reads and writes to SQLite, and returns JSON responses.

## Objective 4: Transitional Steps
- Implement the SQLite layer in Python and verify tests pass.
- Develop the Java server in parallel while keeping the Python server operational.
- Migrate traffic to the Java server once all endpoints are implemented.
- Remove the old Python server and update documentation when the new system is stable.

---
This expanded plan breaks the migration into smaller objectives and tasks for easier tracking.
